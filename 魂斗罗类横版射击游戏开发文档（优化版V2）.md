# 魂斗罗类横版射击游戏开发文档（优化版 V2）

## 一、技术栈配置规范（MAC 环境）

### 1.1 核心开发环境



*   **基础环境**：Node.js（LTS 版本）+ npm/yarn，通过 Homebrew 安装以确保 MAC 兼容性：



```
brew install node@20  # 安装Node.js LTS版本

npm config set registry https://registry.npmmirror.com  # 配置国内镜像加速
```



*   **版本管理**：Git + Husky 配置代码提交规范

*   **开发工具**：VS Code（推荐插件：ESLint、Prettier、WebAssembly Studio）

*   **构建工具**：Vite 用于前端模块打包，支持热重载和生产环境优化

### 1.2 性能优化技术栈



*   **底层计算层**：


    *   Rust 通过`node-rs`绑定实现高性能模块，处理碰撞检测、物理计算等密集型任务

    *   WebAssembly 集成：使用 Emscripten 将 C++ 物理引擎编译为 WASM 模块，通过`wasm-bindgen`与 JS 交互

    *   性能临界模块划分：



```
适合Rust/WASM优化的模块：

\- 碰撞检测算法（BitMask位运算实现）

\- 物理引擎（重力、碰撞响应）

\- 大规模敌人生成与路径计算

\- 像素级图像渲染优化
```



*   **应用逻辑层**：


    *   Node.js 核心框架：Express 用于开发服务器功能（如排行榜、存档）

    *   状态管理：Redux Toolkit 管理游戏全局状态

    *   数据持久化：IndexedDB 存储本地游戏进度

*   **前端渲染层**：


    *   核心引擎：Phaser.js 3.x（专为 2D 横版游戏优化，支持 WebGL 加速）

    *   辅助库：


        *   PixiJS 用于复杂粒子效果渲染

        *   Tween.js 实现平滑动画过渡

    *   跨平台保障：使用 BrowserStack 验证主流浏览器兼容性

## 二、核心架构定义

基于经典横版射击游戏《魂斗罗》的核心玩法，设计模块化游戏开发框架。该框架需支持 "快节奏卷轴式战斗系统"，包含以下核心模块：关卡系统、角色控制系统、武器系统、敌人 AI 系统、碰撞检测系统及游戏状态管理系统。所有模块需采用数据驱动设计，确保参数可配置、逻辑可扩展。

框架设计需特别注意性能优化策略，参考 FC 原版魂斗罗的技术实现，在有限资源下实现流畅的多敌人同屏战斗体验，通过 Rust/WASM 模块处理计算密集型任务，JavaScript 负责业务逻辑与 UI 交互。

## 三、关卡系统设计规范



1.  **关卡结构**：

    实现 8 个纯横版卷轴关卡架构，每个关卡划分为多个独立屏幕（screen），参考初代魂斗罗第一关由 13 个屏幕组成的设计。每个屏幕进一步划分为三个功能段：地形挑战段、敌人压制段、BOSS 战阶段。

2.  **瓦片地图系统**：

*   采用 "超级瓦片（Super Tiles）" 结构：每个超级瓦片为 32×32 像素，由 4×4 个 8×8 像素的普通瓦片组成

*   屏幕尺寸固定为 256×224 像素，包含 8×7 个超级瓦片

*   瓦片索引范围定义碰撞类型：



```
{

&#x20; "floorTiles": \[0x01, 0x05],    // 可站立的地板

&#x20; "emptyTiles": \[0x06, 0xf8],    // 空白区域

&#x20; "waterTiles": \[0xf9, 0xfe],    // 水域

&#x20; "solidTiles": \[0xff]           // 完全固体

}
```



1.  **地形元素**：

*   基础地形：平地、斜坡（实现角色下滑物理效果）、平台（固定 / 移动两种类型）

*   危险区域：深渊（掉落即死亡）、钉刺陷阱、火焰喷射器、滚动油桶（直线运动 + 碰撞爆炸）

*   交互元素：升降电梯（定时升降 + 到达顶端自爆逻辑）、移动吊篮（水平往返运动）、可破坏掩体

1.  **卷轴机制**：

    实现水平自动卷轴与玩家推动卷轴两种模式，定义玩家与屏幕边缘的触发距离（左侧 30%、右侧 70% 触发卷轴移动）。双人模式下需特别处理屏幕拖拽逻辑：当两玩家间距超过屏幕宽度 60% 时触发强制同步。

2.  **关卡数据模板**：



```
{

&#x20; "levelId": 1,

&#x20; "scrollType": "horizontal",

&#x20; "screens": \[

&#x20;   {

&#x20;     "screenId": 1,

&#x20;     "superTiles": \[/\* 8x7超级瓦片索引数组 \*/],

&#x20;     "enemySpawns": \[

&#x20;       {"scrollDistance": 16, "enemyType": "soldier", "position": {"x": 300, "y": 500}}

&#x20;     ],

&#x20;     "collisionMap": \[/\* 16x16碰撞块数据 \*/]

&#x20;   }

&#x20; ]

}
```

## 四、美术素材生成系统（Python 自动化方案）

### 4.1 像素图生成工具链



*   **核心库**：


    *   Pillow（PIL）：基础像素绘制与图像处理

    *   Tiler 库：批量生成地图瓦片与像素图块

    *   Pyxel：辅助生成角色动画帧与特效素材

*   **工具架构**：



```
pixel\_generator/

├── core/            # 核心生成逻辑

│   ├── tile\_generator.py    # 瓦片地图生成器

│   ├── sprite\_generator.py  # 角色精灵生成器

│   └── weapon\_generator.py  # 武器特效生成器

├── config/          # 样式配置

│   ├── color\_palettes.json  # 魂斗罗风格调色板

│   └── tile\_patterns.json   # 瓦片图案定义

├── output/          # 生成结果

└── cli.py           # 命令行工具
```

### 4.2 自动生成流程



1.  **瓦片地图生成**：



```
from PIL import Image

from tiler import Tiler  # 导入Tiler库

\# 初始化瓦片生成器

tile\_generator = Tiler(

&#x20;   tile\_size=8,

&#x20;   palette="config/color\_palettes.json",

&#x20;   patterns="config/tile\_patterns.json"

)

\# 生成地形瓦片集

terrain\_tiles = tile\_generator.generate\_terrain\_set(

&#x20;   types=\["grass", "concrete", "metal"],

&#x20;   variations=3  # 每种地形3种变体

)

terrain\_tiles.save("output/terrain\_tileset.png")

\# 生成碰撞掩码

collision\_mask = tile\_generator.create\_collision\_mask(terrain\_tiles)

collision\_mask.save("output/collision\_mask.json")
```



1.  **角色精灵生成**：

*   支持生成 8 方向角色动画帧

*   自动应用魂斗罗风格调色板（以绿色、棕色为主色调）

*   生成不同武器状态下的角色外观变体

1.  **集成与校验**：

*   生成的素材自动转换为 Phaser.js 兼容格式

*   内置尺寸校验确保符合瓦片地图网格规范

*   批量生成时自动创建素材索引表

## 五、开发步骤规划

### 阶段一：框架搭建



1.  **环境配置**

*   搭建 MAC 开发环境（Node.js、Rust 工具链、Python 环境）

*   配置版本控制与构建流程

*   建立基础项目结构与模块接口文档

1.  **核心架构设计**

*   定义模块间通信协议

*   实现基础游戏循环与状态管理

*   搭建日志系统与性能监控工具

1.  **像素生成工具开发**

*   开发 Python 像素图生成器核心功能

*   实现瓦片地图与角色素材生成逻辑

*   建立素材导出与游戏引擎导入流程

### 阶段二：核心模块开发



1.  **碰撞检测系统**

*   实现 BitMask 位遮罩碰撞技术

*   开发 Rust 优化的碰撞检测模块

*   构建碰撞调试可视化工具

1.  **关卡系统**

*   实现瓦片地图加载与渲染引擎

*   开发卷轴滚动机制与屏幕管理

*   实现地形物理效果（斜坡、水流等）

1.  **角色控制系统**

*   开发角色状态机与动作系统

*   实现移动、跳跃物理引擎

*   优化输入处理与响应机制

1.  **武器与弹道系统**

*   实现武器属性系统与弹道物理

*   开发武器切换与状态管理

*   优化子弹碰撞检测性能

### 阶段三：敌人与 AI 系统



1.  **敌人基础框架**

*   开发敌人状态机系统

*   实现敌人生成与生命周期管理

*   建立敌人属性与伤害计算系统

1.  **AI 行为实现**

*   实现巡逻、追击、攻击等基础行为树

*   开发敌人群控与协作机制

*   优化大规模 AI 计算性能

1.  **BOSS 战系统**

*   开发 BOSS 阶段转换机制

*   实现 BOSS 特殊攻击模式

*   设计弱点判定与伤害倍增系统

### 阶段四：双人模式与关卡内容



1.  **双人协作系统**

*   实现双人输入处理与状态同步

*   开发屏幕跟随与视野同步机制

*   实现双人互动功能（借命、协作攻击）

1.  **关卡内容制作**

*   利用像素生成工具创建 8 个关卡的瓦片地图

*   配置敌人生成点与路径数据

*   设计 BOSS 战场景与机制

1.  **游戏状态管理**

*   实现关卡切换与进度保存

*   开发暂停菜单与设置系统

*   实现游戏结束与评分系统

### 阶段五：优化与测试



1.  **性能优化**

*   优化渲染性能与帧率稳定性

*   优化碰撞检测与 AI 计算效率

*   减少内存占用与资源加载时间

1.  **功能测试**

*   进行模块间集成测试

*   验证双人模式同步稳定性

*   测试武器与敌人平衡

1.  **BUG 修复**

*   修复碰撞穿透与检测错误

*   解决动作状态切换异常

*   修复关卡滚动与敌人生成问题

### 阶段六：扩展功能与验收



1.  **扩展功能开发**

*   实现隐藏关卡与秘密区域

*   开发特殊武器与 power-up 系统

*   增加游戏难度调节机制

1.  **验收测试**

*   按照验收标准进行全面测试

*   收集反馈并进行调整

*   优化游戏体验与平衡性

1.  **发布准备**

*   完善游戏说明与教程

*   准备发布版本与资源打包

*   进行跨浏览器兼容性测试

## 六、其他关键系统规范

（角色控制系统、武器系统、敌人 AI 系统、碰撞检测与物理规范等内容保持优化版 V1 的结构，此处省略）

## 七、数据驱动框架要求



1.  建立以下配置表：

*   关卡配置表（level\_config.csv）

*   武器参数表（weapon\_params.csv）

*   敌人属性表（enemy\_stats.csv）

*   地形元素表（terrain\_elements.csv）

*   素材索引表（assets\_index.json）- 新增，关联 Python 生成的素材

1.  支持热更新：所有数值参数可通过 CSV/JSON 文件修改，无需重新编译代码

2.  日志系统：记录关键事件（武器拾取、敌人击杀、BOSS 阶段转换）用于平衡调整

> （注：文档部分内容可能由 AI 生成）